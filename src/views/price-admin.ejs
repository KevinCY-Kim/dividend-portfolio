<%- include('inc/top', {title:'ì£¼ì‹ ê°€ê²© ê´€ë¦¬'}) %>

<div class="container mt-4">
  <h2 class="mb-4">ğŸ“ˆ ì£¼ì‹ ê°€ê²© ê´€ë¦¬</h2>
  
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ”„ ìë™ ê°€ê²© ì—…ë°ì´íŠ¸ ìƒíƒœ</h5>
        </div>
        <div class="card-body">
          <div id="service-status">
            <p>ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
          </div>
          <button id="refresh-status" class="btn btn-outline-primary btn-sm">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">âš¡ ìˆ˜ë™ ê°€ê²© ì—…ë°ì´íŠ¸</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="ticker-input" class="form-label">ì¢…ëª© í‹°ì»¤:</label>
            <input type="text" id="ticker-input" class="form-control" placeholder="ì˜ˆ: AAPL, MSFT">
          </div>
          <button id="update-single" class="btn btn-warning btn-sm me-2">ê°œë³„ ì—…ë°ì´íŠ¸</button>
          <button id="update-all" class="btn btn-danger btn-sm">ì „ì²´ ì—…ë°ì´íŠ¸</button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“Š ê°€ê²© ì—…ë°ì´íŠ¸ ë¡œê·¸</h5>
        </div>
        <div class="card-body">
          <div id="update-log" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
            <p class="text-muted">ì—…ë°ì´íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
async function checkServiceStatus() {
  try {
    const response = await fetch('/stocks/price-update-status');
    const status = await response.json();
    
    const statusDiv = document.getElementById('service-status');
    statusDiv.innerHTML = `
      <p><strong>ì„œë¹„ìŠ¤ ìƒíƒœ:</strong> <span class="badge bg-success">${status.serviceStatus}</span></p>
      <p><strong>ì‹¤í–‰ ì¤‘:</strong> <span class="badge ${status.isRunning ? 'bg-warning' : 'bg-secondary'}">${status.isRunning ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}</span></p>
      <p><strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> ${status.lastUpdate ? new Date(status.lastUpdate).toLocaleString('ko-KR') : 'ì—†ìŒ'}</p>
    `;
  } catch (error) {
    console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
    document.getElementById('service-status').innerHTML = '<p class="text-danger">ìƒíƒœ í™•ì¸ ì‹¤íŒ¨</p>';
  }
}

// ë¡œê·¸ ì¶”ê°€
function addLog(message, type = 'info') {
  const logDiv = document.getElementById('update-log');
  const timestamp = new Date().toLocaleString('ko-KR');
  const logEntry = document.createElement('div');
  logEntry.className = `mb-2 p-2 rounded ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : 'bg-info text-white'}`;
  logEntry.innerHTML = `<small>${timestamp}</small><br>${message}`;
  
  logDiv.appendChild(logEntry);
  logDiv.scrollTop = logDiv.scrollHeight;
}

// ê°œë³„ ì¢…ëª© ê°€ê²© ì—…ë°ì´íŠ¸
async function updateSinglePrice(ticker) {
  if (!ticker) {
    addLog('í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  
  try {
    addLog(`${ticker} ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘...`, 'info');
    
    const response = await fetch(`/stocks/update-price/${ticker}`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      addLog(`${ticker} ê°€ê²© ì—…ë°ì´íŠ¸ ì„±ê³µ: $${result.price}`, 'success');
    } else {
      addLog(`${ticker} ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
    }
  } catch (error) {
    addLog(`${ticker} ê°€ê²© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
  }
}

// ì „ì²´ ê°€ê²© ì—…ë°ì´íŠ¸
async function updateAllPrices() {
  try {
    addLog('ì „ì²´ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘...', 'info');
    
    const response = await fetch('/stocks/update-all-prices', {
      method: 'POST'
    });
    
    const result = await response.json();
    addLog(result.message, 'success');
    
    // 5ì´ˆ í›„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
    setTimeout(checkServiceStatus, 5000);
  } catch (error) {
    addLog(`ì „ì²´ ê°€ê²© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
  // ì´ˆê¸° ìƒíƒœ í™•ì¸
  checkServiceStatus();
  
  // ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
  document.getElementById('refresh-status').addEventListener('click', checkServiceStatus);
  
  // ê°œë³„ ì—…ë°ì´íŠ¸ ë²„íŠ¼
  document.getElementById('update-single').addEventListener('click', function() {
    const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
    updateSinglePrice(ticker);
  });
  
  // ì „ì²´ ì—…ë°ì´íŠ¸ ë²„íŠ¼
  document.getElementById('update-all').addEventListener('click', updateAllPrices);
  
  // Enter í‚¤ë¡œ ê°œë³„ ì—…ë°ì´íŠ¸
  document.getElementById('ticker-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const ticker = this.value.trim().toUpperCase();
      updateSinglePrice(ticker);
    }
  });
});

// 30ì´ˆë§ˆë‹¤ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨
setInterval(checkServiceStatus, 30000);
</script>

<%- include('inc/bottom') %>
