<%- include('inc/top', {title:'í¬íŠ¸í´ë¦¬ì˜¤'}) %>

<style>
  /* ì‹¬í”Œí•œ ìŠ¤íƒ€ì¼ ì ìš© */
  .container {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 24px;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  h2 {
    color: #333333;
    font-weight: 600;
    margin-bottom: 24px;
    font-size: 1.8rem;
  }

  .card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    transition: box-shadow 0.2s ease;
  }

  .card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  .card-header {
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    padding: 16px 20px;
  }

  .card-header h5 {
    color: #374151;
    font-weight: 600;
    margin: 0;
    font-size: 1.1rem;
  }

  .card-body {
    padding: 20px;
  }

  .card-title {
    color: #6b7280;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 8px;
  }

  /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .text-primary {
    color: #2563eb !important;
    font-weight: 600;
  }

  .text-success {
    color: #059669 !important;
    font-weight: 600;
  }

  .text-info {
    color: #0891b2 !important;
    font-weight: 600;
  }

  .text-warning {
    color: #d97706 !important;
    font-weight: 600;
  }

  /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
  .table {
    font-size: 14px;
    margin-bottom: 0;
  }

  .table th {
    background-color: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    color: #374151;
    font-weight: 600;
    padding: 12px 16px;
    font-size: 13px;
  }

  .table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f3f4f6;
    color: #374151;
    vertical-align: middle;
  }

  .table tbody tr:hover {
    background-color: #f9fafb;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn {
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-outline-primary {
    border: 1px solid #2563eb;
    color: #2563eb;
    background-color: transparent;
  }

  .btn-outline-primary:hover {
    background-color: #2563eb;
    color: white;
  }

  .btn-outline-secondary {
    border: 1px solid #6b7280;
    color: #6b7280;
    background-color: transparent;
  }

  .btn-outline-secondary:hover {
    background-color: #6b7280;
    color: white;
  }

  .btn-danger {
    background-color: #dc2626;
    border-color: #dc2626;
    color: white;
  }

  .btn-danger:hover {
    background-color: #b91c1c;
    border-color: #b91c1c;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
  .text-muted {
    color: #6b7280 !important;
  }

  .text-success {
    color: #059669 !important;
  }

  .text-danger {
    color: #dc2626 !important;
  }

  /* ì½”ë“œ ìŠ¤íƒ€ì¼ */
  code {
    background-color: #f3f4f6;
    color: #374151;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Courier New', monospace;
  }

  /* ë§í¬ ìŠ¤íƒ€ì¼ */
  a {
    color: #2563eb;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
  #portfolio-chart {
    max-height: 300px;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ“Š ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h2>
    <div>
      <a href="/select" class="btn btn-outline-primary btn-sm me-2">
        ğŸ” ì¢…ëª© ì¶”ê°€
      </a>
      <a href="/price-admin" class="btn btn-outline-secondary btn-sm">
        ğŸ“ˆ ê°€ê²© ê´€ë¦¬
      </a>
    </div>
  </div>

  <!-- í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">ì´ í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜</h5>
          <h3 class="text-primary" id="total-value">$0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">ì´ ë°°ë‹¹ê¸ˆ</h5>
          <h3 class="text-success" id="total-dividend">$0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">ì†ìµ</h5>
          <h3 class="text-info" id="total-gain-loss">$0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">ë³´ìœ  ì¢…ëª© ìˆ˜</h5>
          <h3 class="text-warning" id="total-stocks">0</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- í¬íŠ¸í´ë¦¬ì˜¤ ì¢…ëª© ëª©ë¡ -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">ë³´ìœ  ì¢…ëª©</h5>
    </div>
    <div class="card-body">
      <div id="portfolio-stocks">
        <p class="text-muted">í¬íŠ¸í´ë¦¬ì˜¤ì— ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. <a href="/select">ì¢…ëª©ì„ ì¶”ê°€</a>í•´ë³´ì„¸ìš”.</p>
      </div>
    </div>
  </div>

  <!-- ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸ -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">ì›”ë³„ í¬íŠ¸í´ë¦¬ì˜¤ ë°°ë‹¹ ì°¨íŠ¸</h5>
    </div>
    <div class="card-body">
      <canvas id="portfolio-chart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let portfolioChart;
let portfolioData = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/portfolio');
    portfolioData = await response.json();
    
    updatePortfolioDisplay();
    updatePortfolioChart();
  } catch (error) {
    console.error('í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
  }
});

// í¬íŠ¸í´ë¦¬ì˜¤ í‘œì‹œ ì—…ë°ì´íŠ¸
function updatePortfolioDisplay() {
  if (!portfolioData || !portfolioData.stocks || portfolioData.stocks.length === 0) {
    document.getElementById('portfolio-stocks').innerHTML = 
      '<p class="text-muted">í¬íŠ¸í´ë¦¬ì˜¤ì— ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. <a href="/select">ì¢…ëª©ì„ ì¶”ê°€</a>í•´ë³´ì„¸ìš”.</p>';
    return;
  }

  // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
  document.getElementById('total-value').textContent = `$${portfolioData.totalValue.toFixed(2)}`;
  document.getElementById('total-dividend').textContent = `$${portfolioData.totalDividend.toFixed(2)}`;
  document.getElementById('total-gain-loss').textContent = `$${portfolioData.totalGainLoss.toFixed(2)}`;
  document.getElementById('total-stocks').textContent = portfolioData.stocks.length;

  // ì¢…ëª© ëª©ë¡ í…Œì´ë¸” ìƒì„±
  const stocksHtml = `
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ì¢…ëª©</th>
            <th>í‹°ì»¤</th>
            <th>ë³´ìœ  ì£¼ì‹ ìˆ˜</th>
            <th>í‰ê·  ë§¤ìˆ˜ê°€</th>
            <th>í˜„ì¬ê°€</th>
            <th>í˜„ì¬ ê°€ì¹˜</th>
            <th>ì†ìµ</th>
            <th>ì†ìµë¥ </th>
            <th>ë°°ë‹¹ ìˆ˜ìµë¥ </th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>
          ${portfolioData.stocks.map(stock => `
            <tr>
              <td>
                <strong>${stock.name}</strong><br>
                <small class="text-muted">${stock.index}</small>
              </td>
              <td><code>${stock.ticker}</code></td>
              <td>${stock.shares.toLocaleString()}</td>
              <td>$${stock.averagePrice.toFixed(2)}</td>
              <td>$${stock.currentPrice.toFixed(2)}</td>
              <td>$${stock.currentValue.toFixed(2)}</td>
              <td class="${stock.gainLoss >= 0 ? 'text-success' : 'text-danger'}">
                $${stock.gainLoss.toFixed(2)}
              </td>
              <td class="${stock.gainLossPercent >= 0 ? 'text-success' : 'text-danger'}">
                ${stock.gainLossPercent}%
              </td>
              <td>${stock.dividendYield}%</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="removeStock('${stock.ticker}')">
                  ì œê±°
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  document.getElementById('portfolio-stocks').innerHTML = stocksHtml;
}

// í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updatePortfolioChart() {
  if (portfolioChart) {
    portfolioChart.destroy();
  }

  if (!portfolioData || !portfolioData.stocks || portfolioData.stocks.length === 0) {
    return;
  }

  const ctx = document.getElementById('portfolio-chart').getContext('2d');
  
  // ì›”ë³„ ë°°ë‹¹ ë°ì´í„° ì¤€ë¹„
  const monthlyData = new Array(12).fill(0);
  const monthLabels = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
  
  // ê° ì¢…ëª©ì˜ ì›”ë³„ ë°°ë‹¹ì„ ì£¼ì‹ ìˆ˜ì— ê³±í•´ì„œ ëˆ„ì 
  portfolioData.stocks.forEach(stock => {
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ ê³ ì • ë°°ë‹¹ê¸ˆ ì‚¬ìš©
    // ì‹¤ì œë¡œëŠ” Stock ëª¨ë¸ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
    const monthlyDividend = 0.4; // ì˜ˆì‹œ ê°’
    monthlyData[0] += monthlyDividend * stock.shares;  // 1ì›”
    monthlyData[2] += monthlyDividend * stock.shares;  // 3ì›”
    monthlyData[4] += monthlyDividend * stock.shares;  // 5ì›”
    monthlyData[7] += monthlyDividend * stock.shares;  // 8ì›”
    monthlyData[10] += monthlyDividend * stock.shares; // 11ì›”
  });

  portfolioChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'í¬íŠ¸í´ë¦¬ì˜¤ ì›”ë³„ ë°°ë‹¹ê¸ˆ ($)',
        data: monthlyData,
        backgroundColor: 'rgba(37, 99, 235, 0.7)',
        borderColor: 'rgba(37, 99, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'í¬íŠ¸í´ë¦¬ì˜¤ ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸',
          color: '#374151',
          font: {
            size: 16,
            weight: '600'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return value > 0 ? `ë°°ë‹¹ê¸ˆ: $${value.toFixed(2)}` : 'ë°°ë‹¹ ì—†ìŒ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ë°°ë‹¹ê¸ˆ ($)',
            color: '#6b7280'
          },
          grid: {
            color: '#f3f4f6'
          }
        },
        x: {
          title: {
            display: true,
            text: 'ì›”',
            color: '#6b7280'
          },
          grid: {
            color: '#f3f4f6'
          }
        }
      }
    }
  });
}

// ì¢…ëª© ì œê±°
async function removeStock(ticker) {
  if (!confirm(`ì •ë§ë¡œ ${ticker}ë¥¼ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  try {
    const response = await fetch(`/portfolio/remove/${ticker}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      
      // í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      const portfolioResponse = await fetch('/portfolio');
      portfolioData = await portfolioResponse.json();
      
      // í™”ë©´ ì—…ë°ì´íŠ¸
      updatePortfolioDisplay();
      updatePortfolioChart();
    } else {
      alert('ì˜¤ë¥˜: ' + result.error);
    }
  } catch (error) {
    console.error('ì¢…ëª© ì œê±° ì˜¤ë¥˜:', error);
    alert('ì¢…ëª© ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}
</script>

<%- include('inc/bottom') %>
