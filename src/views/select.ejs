<%- include('inc/top', {title:'ë°°ë‹¹ì£¼ ì„ íƒ'}) %>
<<<<<<< HEAD
<h2>ë°°ë‹¹ì£¼ ì„ íƒ</h2>
<select id="ticker-select"></select>
<button id="add-btn" type="button">ì¶”ê°€</button>

<h3>ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸</h3>
<iframe src="/charts/portfolio" width="100%" height="420" style="border:0;"></iframe>
=======

<style>
  .sortable {
    cursor: pointer;
    user-select: none;
  }
  
  .sortable:hover {
    background-color: #ffffff !important;
  }
  
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  .badge {
    font-size: 0.8em;
  }
  
  /* í…Œì´ë¸” ê°€ë…ì„± ê°œì„  */
  .table {
    font-size: 14px;
    line-height: 1.4;
    background-color: white;
  }
  
  .table th {
    font-size: 15px;
    font-weight: 600;
    padding: 16px 12px;
    vertical-align: middle;
    border-bottom: 2px solid #dee2e6;
    color: #000000;
  }
  
  .table td {
    padding: 14px 12px;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
    color: #000000;
    background-color: white;
  }
  
  .table tbody tr {
    transition: none;
    background-color: white;
  }
  
  .table tbody tr:hover {
    background-color: white !important;
    transform: none;
    box-shadow: none;
  }
  
  /* í˜¸ë²„ íš¨ê³¼ ì œê±° */
  .table tbody tr:hover td:nth-child(1),
  .table tbody tr:hover td:nth-child(2),
  .table tbody tr:hover td:nth-child(3),
  .table tbody tr:hover td:nth-child(4),
  .table tbody tr:hover td:nth-child(5),
  .table tbody tr:hover td:nth-child(6) {
    color: #000000 !important;
  }
  
  /* í˜¸ë²„ ì‹œ ì¸ë±ìŠ¤ ë°°ì§€ íš¨ê³¼ ì œê±° */
  .table tbody tr:hover .badge {
    color: #000000 !important;
    background-color: white !important;
    border-color: #dee2e6 !important;
  }
  
  /* ì»¬ëŸ¼ë³„ ë„ˆë¹„ ì¡°ì • */
  .table th:nth-child(1), .table td:nth-child(1) { /* í‹°ì»¤ */
    width: 80px;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(2), .table td:nth-child(2) { /* ì¢…ëª©ëª… */
    width: 200px;
    font-weight: 500;
    color: #000000;
  }
  
  .table th:nth-child(3), .table td:nth-child(3) { /* ì¸ë±ìŠ¤ */
    width: 120px;
    text-align: center;
    color: #000000;
  }
  
  .table th:nth-child(4), .table td:nth-child(4) { /* í˜„ì¬ê°€ */
    width: 100px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(5), .table td:nth-child(5) { /* ì—°ê°„ ë°°ë‹¹ê¸ˆ */
    width: 120px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(6), .table td:nth-child(6) { /* ë°°ë‹¹ ìˆ˜ìµë¥  */
    width: 120px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(7), .table td:nth-child(7) { /* ë°°ë‹¹ì›” */
    width: 150px;
    text-align: center;
    color: #000000;
  }
  
  /* ì¸ë±ìŠ¤ ë°°ì§€ ìŠ¤íƒ€ì¼ ì œê±° */
  .badge {
    display: none;
  }
  
  .badge.bg-primary {
    display: none;
  }
  
  /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ê°œì„  */
  .table-responsive {
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    background: white;
  }
  
  /* í…Œì´ë¸” í—¤ë” ê°œì„  */
  .table-dark {
    background: white;
    border: none;
  }
  
  .table-dark th {
    border: none;
    color: #000000;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  /* í…Œì´ë¸” ë‚´ìš© ë°°ê²½ */
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: white;
  }
  
  .table-striped tbody tr:nth-of-type(even) {
    background-color: white;
  }
  
  /* ì •ë ¬ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼ */
  .sort-arrow {
    font-size: 12px;
    margin-left: 5px;
    opacity: 0.7;
    transition: all 0.2s ease;
  }
  
  .sortable:hover .sort-arrow {
    opacity: 1;
    transform: scale(1.1);
  }
  
  /* ì •ë ¬ ë°©í–¥ì— ë”°ë¥¸ í™”ì‚´í‘œ ë³€ê²½ */
  .sortable[data-order="asc"] .sort-arrow::after {
    content: "â†‘";
    color: #28a745;
  }
  
  .sortable[data-order="desc"] .sort-arrow::after {
    content: "â†“";
    color: #dc3545;
  }
  
  /* í…Œì´ë¸” ì œëª© ìŠ¤íƒ€ì¼ */
  .table-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 3px solid #007bff;
    display: inline-block;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ë°°ë‹¹ì£¼ ì„ íƒ</h2>
    <a href="/price-admin" class="btn btn-outline-primary btn-sm">
      ğŸ“ˆ ê°€ê²© ê´€ë¦¬
    </a>
  </div>
  
  <div class="row mb-4">
    <div class="col-md-4">
      <label for="index-select" class="form-label">ì¸ë±ìŠ¤ ì„ íƒ:</label>
      <select id="index-select" class="form-select">
        <option value="">ì „ì²´ ì¸ë±ìŠ¤</option>
        <option value="NASDAQ-100">NASDAQ-100</option>
        <option value="S&P 500">S&P 500</option>
        <option value="US ETF">US ETF</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="ticker-select" class="form-label">ì¢…ëª© ì„ íƒ:</label>
      <select id="ticker-select" class="form-select" disabled>
        <option value="">ë¨¼ì € ì¸ë±ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>
    <div class="col-md-4">
      <button id="add-btn" type="button" class="btn btn-primary" disabled>í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€</button>
    </div>
  </div>

  <div id="stock-info" class="mb-4" style="display: none;">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" id="stock-name"></h5>
        <p class="card-text">
          <strong>í‹°ì»¤:</strong> <span id="stock-ticker"></span><br>
          <strong>ì¸ë±ìŠ¤</strong> <span id="stock-index"></span><br>
          <strong>í˜„ì¬ê°€</strong> <span id="stock-price"></span><br>
          <strong>ë°°ë‹¹ì›”</strong> <span id="dividend-months"></span><br>
          <strong>ì—°ê°„ ë°°ë‹¹ê¸ˆ</strong> <span id="annual-dividend"></span>
        </p>
      </div>
    </div>
  </div>

  <h3 class="mb-3">ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸</h3>
  <div id="chart-container">
    <canvas id="dividend-chart" width="400" height="200"></canvas>
  </div>

  <!-- ì¢…ëª© ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
  <div class="mt-4">
    <h4 class="table-title">ğŸ“Š ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th scope="col" class="sortable" data-sort="ticker" data-order="asc" onclick="sortTable('ticker')">
              í‹°ì»¤ <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="name" data-order="asc" onclick="sortTable('name')">
              ì¢…ëª©ëª… <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="index" data-order="asc" onclick="sortTable('index')">
              ì¸ë±ìŠ¤ <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="price" data-order="asc" onclick="sortTable('price')">
              í˜„ì¬ê°€ <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="dividend" data-order="asc" onclick="sortTable('dividend')">
              ì—°ê°„ë°°ë‹¹ê¸ˆ <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="yield" data-order="asc" onclick="sortTable('yield')">
              ë°°ë‹¹ìˆ˜ìµë¥  <span class="sort-arrow"></span>
            </th>
            <th scope="col">ë°°ë‹¹ì›”</th>
          </tr>
        </thead>
        <tbody id="stocks-table-body">
          <!-- ì¢…ëª© ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let dividendChart;
let stocksData = [];
let filteredStocks = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢…ëª© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/stocks');
    stocksData = await response.json();
    filteredStocks = [...stocksData];
    
    // ì¸ë±ìŠ¤ë³„ í†µê³„ í‘œì‹œ
    displayIndexStats();
    updateStocksTable(); // í…Œì´ë¸” ì´ˆê¸° ë¡œë”© ì‹œ ì—…ë°ì´íŠ¸
  } catch (error) {
    console.error('ì¢…ëª© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
  }
});

// ì¸ë±ìŠ¤ë³„ í†µê³„ í‘œì‹œ
function displayIndexStats() {
  const stats = {};
  stocksData.forEach(stock => {
    if (!stats[stock.index]) {
      stats[stock.index] = { count: 0, totalDividends: 0 };
    }
    stats[stock.index].count++;
    stats[stock.index].totalDividends += stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
  });
  
  console.log('ì¸ë±ìŠ¤ë³„ í†µê³„:', stats);
}

// ì¸ë±ìŠ¤ ì„ íƒ ì‹œ ì´ë²¤íŠ¸
document.getElementById('index-select').addEventListener('change', function() {
  const selectedIndex = this.value;
  const tickerSelect = document.getElementById('ticker-select');
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  // ì¢…ëª© ì„ íƒ ì´ˆê¸°í™”
  tickerSelect.innerHTML = '<option value="">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
  tickerSelect.disabled = false;
  addBtn.disabled = true;
  stockInfo.style.display = 'none';
  
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  // ì¸ë±ìŠ¤ì— ë”°ë¼ ì¢…ëª© í•„í„°ë§
  if (selectedIndex) {
    filteredStocks = stocksData.filter(stock => stock.index === selectedIndex);
  } else {
    filteredStocks = [...stocksData];
  }
  
  // ì¢…ëª© ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
  filteredStocks.forEach(stock => {
    const option = document.createElement('option');
    option.value = stock.ticker;
    option.textContent = `${stock.ticker} - ${stock.name}`;
    tickerSelect.appendChild(option);
  });
  
  // ì¸ë±ìŠ¤ ì„ íƒ í›„ ì•ˆë‚´ ë©”ì‹œì§€
  if (selectedIndex) {
    tickerSelect.innerHTML = `<option value="">${selectedIndex}ì—ì„œ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>`;
    filteredStocks.forEach(stock => {
      const option = document.createElement('option');
      option.value = stock.ticker;
      option.textContent = `${stock.ticker} - ${stock.name}`;
      tickerSelect.appendChild(option);
    });
  }
  updateStocksTable(); // ì¸ë±ìŠ¤ ë³€ê²½ ì‹œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
});

// ì¢…ëª© ì„ íƒ ì‹œ ì´ë²¤íŠ¸
document.getElementById('ticker-select').addEventListener('change', function() {
  const selectedTicker = this.value;
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  if (selectedTicker) {
    addBtn.disabled = false;
    showStockInfo(selectedTicker);
    updateDividendChart(selectedTicker);
  } else {
    addBtn.disabled = true;
    stockInfo.style.display = 'none';
    if (dividendChart) {
      dividendChart.destroy();
    }
  }
});

// ì¢…ëª© ì •ë³´ í‘œì‹œ
function showStockInfo(ticker) {
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (!stock) return;
  
  document.getElementById('stock-name').textContent = stock.name;
  document.getElementById('stock-ticker').textContent = stock.ticker;
  document.getElementById('stock-index').textContent = stock.index;
  document.getElementById('stock-price').textContent = `$${stock.price}`;
  
  // ë°°ë‹¹ì›” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const dividendMonths = getDividendMonths(stock);
  document.getElementById('dividend-months').textContent = dividendMonths.join(', ');
  
  // ì—°ê°„ ë°°ë‹¹ê¸ˆ ê³„ì‚°
  const annualDividend = calculateAnnualDividend(stock);
  document.getElementById('annual-dividend').textContent = `$${annualDividend.toFixed(2)}`;
  
  document.getElementById('stock-info').style.display = 'block';
}

// ì¢…ëª© ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
function updateStocksTable() {
  const tbody = document.getElementById('stocks-table-body');
  tbody.innerHTML = '';
  
  filteredStocks.forEach(stock => {
    const annualDividend = calculateAnnualDividend(stock);
    const dividendYield = ((annualDividend / stock.price) * 100).toFixed(2);
    const dividendMonths = getDividendMonths(stock);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${stock.ticker}</strong></td>
      <td>${stock.name}</td>
      <td>${stock.index}</td>
      <td>$${stock.price}</td>
      <td>$${annualDividend.toFixed(2)}</td>
      <td>${dividendYield}%</td>
      <td>${dividendMonths.join(', ')}</td>
    `;
    
    // í–‰ í´ë¦­ ì‹œ ì¢…ëª© ì •ë³´ í‘œì‹œ
    row.style.cursor = 'pointer';
    row.addEventListener('click', () => {
      document.getElementById('ticker-select').value = stock.ticker;
      showStockInfo(stock.ticker);
      updateDividendChart(stock.ticker);
    });
    
    tbody.appendChild(row);
  });
}

// í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
function sortTable(column) {
  const sortOrder = document.querySelector(`[data-sort="${column}"]`).getAttribute('data-order') === 'asc' ? -1 : 1;
  
  // ëª¨ë“  í—¤ë”ì˜ ì •ë ¬ ìˆœì„œ ì´ˆê¸°í™”
  document.querySelectorAll('[data-sort]').forEach(th => th.setAttribute('data-order', 'asc'));
  
  // í˜„ì¬ í—¤ë”ì˜ ì •ë ¬ ìˆœì„œ ì„¤ì •
  document.querySelector(`[data-sort="${column}"]`).setAttribute('data-order', sortOrder === 1 ? 'asc' : 'desc');
  
  // ë°ì´í„° ì •ë ¬
  filteredStocks.sort((a, b) => {
    let aVal, bVal;
    
    switch(column) {
      case 'ticker':
        aVal = a.ticker;
        bVal = b.ticker;
        break;
      case 'name':
        aVal = a.name;
        bVal = b.name;
        break;
      case 'index':
        aVal = a.index;
        bVal = b.index;
        break;
      case 'price':
        aVal = parseFloat(a.price);
        bVal = parseFloat(b.price);
        break;
      case 'dividend':
        aVal = calculateAnnualDividend(a);
        bVal = calculateAnnualDividend(b);
        break;
      case 'yield':
        aVal = (calculateAnnualDividend(a) / a.price) * 100;
        bVal = (calculateAnnualDividend(b) / b.price) * 100;
        break;
      default:
        return 0;
    }
    
    if (aVal < bVal) return -1 * sortOrder;
    if (aVal > bVal) return 1 * sortOrder;
    return 0;
  });
  
  updateStocksTable();
  updateDividendChart(filteredStocks[0]);
}

// ë°°ë‹¹ì›” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getDividendMonths(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return ['ë°°ë‹¹ ì—†ìŒ'];
  }
  
  const monthNames = [
    '1', '2', '3', '4', '5', '6',
    '7', '8', '9', '10', '11', '12'
  ];
  
  return stock.dividends2024
    .map(d => monthNames[d.month - 1])
    .sort((a, b) => monthNames.indexOf(a) - monthNames.indexOf(b));
}

// ì—°ê°„ ë°°ë‹¹ê¸ˆ ê³„ì‚°
function calculateAnnualDividend(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return 0;
  }
  
  return stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
}

// ë°°ë‹¹ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updateDividendChart(ticker) {
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  const ctx = document.getElementById('dividend-chart').getContext('2d');
  
  // ì›”ë³„ ë°°ë‹¹ ë°ì´í„° ì¤€ë¹„
  const monthlyData = new Array(12).fill(0);
  const monthLabels = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
  
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (stock && stock.dividends2024) {
    stock.dividends2024.forEach(dividend => {
      monthlyData[dividend.month - 1] = dividend.amount;
    });
  }
  
  dividendChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'ë°°ë‹¹ê¸ˆ ($)',
        data: monthlyData,
        backgroundColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(200, 200, 200, 0.3)'),
        borderColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(200, 200, 200, 0.5)'),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `${ticker} ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸`
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return value > 0 ? `ë°°ë‹¹ê¸ˆ: $${value.toFixed(2)}` : 'ë°°ë‹¹ ì—†ìŒ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ë°°ë‹¹ê¸ˆ ($)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'ì›”'
          }
        }
      }
    }
  });
}

// í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('add-btn').addEventListener('click', function() {
  const selectedTicker = document.getElementById('ticker-select').value;
  if (selectedTicker) {
    // ì—¬ê¸°ì— í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ê°€ ë¡œì§ êµ¬í˜„
    alert(`${selectedTicker}ê°€ í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
});
</script>

>>>>>>> update for dividend
<%- include('inc/bottom') %>
