<%- include('inc/top', {title:'ë°°ë‹¹ì£¼ ì„ íƒ'}) %>
<<<<<<< HEAD
<h2>ë°°ë‹¹ì£¼ ì„ íƒ</h2>
<select id="ticker-select"></select>
<button id="add-btn" type="button">ì¶”ê°€</button>

<h3>ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸</h3>
<iframe src="/charts/portfolio" width="100%" height="420" style="border:0;"></iframe>
=======

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ë°°ë‹¹ì£¼ ì„ íƒ</h2>
    <a href="/price-admin" class="btn btn-outline-primary btn-sm">
      ğŸ“ˆ ê°€ê²© ê´€ë¦¬
    </a>
  </div>
  
  <div class="row mb-4">
    <div class="col-md-4">
      <label for="index-select" class="form-label">ì¸ë±ìŠ¤ ì„ íƒ:</label>
      <select id="index-select" class="form-select">
        <option value="">ì „ì²´ ì¸ë±ìŠ¤</option>
        <option value="NASDAQ-100">NASDAQ-100</option>
        <option value="S&P 500">S&P 500</option>
        <option value="US ETF">US ETF</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="ticker-select" class="form-label">ì¢…ëª© ì„ íƒ:</label>
      <select id="ticker-select" class="form-select" disabled>
        <option value="">ë¨¼ì € ì¸ë±ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>
    <div class="col-md-4">
      <button id="add-btn" type="button" class="btn btn-primary" disabled>í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€</button>
    </div>
  </div>

  <div id="stock-info" class="mb-4" style="display: none;">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" id="stock-name"></h5>
        <p class="card-text">
          <strong>í‹°ì»¤:</strong> <span id="stock-ticker"></span><br>
          <strong>ì¸ë±ìŠ¤:</strong> <span id="stock-index"></span><br>
          <strong>í˜„ì¬ê°€:</strong> <span id="stock-price"></span><br>
          <strong>ë°°ë‹¹ì›”:</strong> <span id="dividend-months"></span><br>
          <strong>ì—°ê°„ ë°°ë‹¹ê¸ˆ:</strong> <span id="annual-dividend"></span>
        </p>
      </div>
    </div>
  </div>

  <h3 class="mb-3">ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸</h3>
  <div id="chart-container">
    <canvas id="dividend-chart" width="400" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let dividendChart;
let stocksData = [];
let filteredStocks = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢…ëª© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/stocks');
    stocksData = await response.json();
    filteredStocks = [...stocksData];
    
    // ì¸ë±ìŠ¤ë³„ í†µê³„ í‘œì‹œ
    displayIndexStats();
  } catch (error) {
    console.error('ì¢…ëª© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
  }
});

// ì¸ë±ìŠ¤ë³„ í†µê³„ í‘œì‹œ
function displayIndexStats() {
  const stats = {};
  stocksData.forEach(stock => {
    if (!stats[stock.index]) {
      stats[stock.index] = { count: 0, totalDividends: 0 };
    }
    stats[stock.index].count++;
    stats[stock.index].totalDividends += stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
  });
  
  console.log('ğŸ“Š ì¸ë±ìŠ¤ë³„ í†µê³„:', stats);
}

// ì¸ë±ìŠ¤ ì„ íƒ ì‹œ ì´ë²¤íŠ¸
document.getElementById('index-select').addEventListener('change', function() {
  const selectedIndex = this.value;
  const tickerSelect = document.getElementById('ticker-select');
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  // ì¢…ëª© ì„ íƒ ì´ˆê¸°í™”
  tickerSelect.innerHTML = '<option value="">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
  tickerSelect.disabled = false;
  addBtn.disabled = true;
  stockInfo.style.display = 'none';
  
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  // ì¸ë±ìŠ¤ì— ë”°ë¼ ì¢…ëª© í•„í„°ë§
  if (selectedIndex) {
    filteredStocks = stocksData.filter(stock => stock.index === selectedIndex);
  } else {
    filteredStocks = [...stocksData];
  }
  
  // ì¢…ëª© ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
  filteredStocks.forEach(stock => {
    const option = document.createElement('option');
    option.value = stock.ticker;
    option.textContent = `${stock.ticker} - ${stock.name}`;
    tickerSelect.appendChild(option);
  });
  
  // ì¸ë±ìŠ¤ ì„ íƒ í›„ ì•ˆë‚´ ë©”ì‹œì§€
  if (selectedIndex) {
    tickerSelect.innerHTML = `<option value="">${selectedIndex}ì—ì„œ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>`;
    filteredStocks.forEach(stock => {
      const option = document.createElement('option');
      option.value = stock.ticker;
      option.textContent = `${stock.ticker} - ${stock.name}`;
      tickerSelect.appendChild(option);
    });
  }
});

// ì¢…ëª© ì„ íƒ ì‹œ ì´ë²¤íŠ¸
document.getElementById('ticker-select').addEventListener('change', function() {
  const selectedTicker = this.value;
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  if (selectedTicker) {
    addBtn.disabled = false;
    showStockInfo(selectedTicker);
    updateDividendChart(selectedTicker);
  } else {
    addBtn.disabled = true;
    stockInfo.style.display = 'none';
    if (dividendChart) {
      dividendChart.destroy();
    }
  }
});

// ì¢…ëª© ì •ë³´ í‘œì‹œ
function showStockInfo(ticker) {
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (!stock) return;
  
  document.getElementById('stock-name').textContent = stock.name;
  document.getElementById('stock-ticker').textContent = stock.ticker;
  document.getElementById('stock-index').textContent = stock.index;
  document.getElementById('stock-price').textContent = `$${stock.price}`;
  
  // ë°°ë‹¹ì›” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const dividendMonths = getDividendMonths(stock);
  document.getElementById('dividend-months').textContent = dividendMonths.join(', ');
  
  // ì—°ê°„ ë°°ë‹¹ê¸ˆ ê³„ì‚°
  const annualDividend = calculateAnnualDividend(stock);
  document.getElementById('annual-dividend').textContent = `$${annualDividend.toFixed(2)}`;
  
  document.getElementById('stock-info').style.display = 'block';
}

// ë°°ë‹¹ì›” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getDividendMonths(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return ['ë°°ë‹¹ ì—†ìŒ'];
  }
  
  const monthNames = [
    '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”',
    '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'
  ];
  
  return stock.dividends2024
    .map(d => monthNames[d.month - 1])
    .sort((a, b) => monthNames.indexOf(a) - monthNames.indexOf(b));
}

// ì—°ê°„ ë°°ë‹¹ê¸ˆ ê³„ì‚°
function calculateAnnualDividend(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return 0;
  }
  
  return stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
}

// ë°°ë‹¹ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updateDividendChart(ticker) {
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  const ctx = document.getElementById('dividend-chart').getContext('2d');
  
  // ì›”ë³„ ë°°ë‹¹ ë°ì´í„° ì¤€ë¹„
  const monthlyData = new Array(12).fill(0);
  const monthLabels = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
  
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (stock && stock.dividends2024) {
    stock.dividends2024.forEach(dividend => {
      monthlyData[dividend.month - 1] = dividend.amount;
    });
  }
  
  dividendChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'ë°°ë‹¹ê¸ˆ ($)',
        data: monthlyData,
        backgroundColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(200, 200, 200, 0.3)'),
        borderColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(200, 200, 200, 0.5)'),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `${ticker} ì›”ë³„ ë°°ë‹¹ ì°¨íŠ¸`
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return value > 0 ? `ë°°ë‹¹ê¸ˆ: $${value.toFixed(2)}` : 'ë°°ë‹¹ ì—†ìŒ';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ë°°ë‹¹ê¸ˆ ($)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'ì›”'
          }
        }
      }
    }
  });
}

// í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('add-btn').addEventListener('click', function() {
  const selectedTicker = document.getElementById('ticker-select').value;
  if (selectedTicker) {
    // ì—¬ê¸°ì— í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ê°€ ë¡œì§ êµ¬í˜„
    alert(`${selectedTicker}ê°€ í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
});
</script>

>>>>>>> update for dividend
<%- include('inc/bottom') %>
