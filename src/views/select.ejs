<%- include('inc/top', {title:'배당주 선택'}) %>
<<<<<<< HEAD
<h2>배당주 선택</h2>
<select id="ticker-select"></select>
<button id="add-btn" type="button">추가</button>

<h3>월별 배당 차트</h3>
<iframe src="/charts/portfolio" width="100%" height="420" style="border:0;"></iframe>
=======

<style>
  .sortable {
    cursor: pointer;
    user-select: none;
  }
  
  .sortable:hover {
    background-color: #ffffff !important;
  }
  
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  .badge {
    font-size: 0.8em;
  }
  
  /* 테이블 가독성 개선 */
  .table {
    font-size: 14px;
    line-height: 1.4;
    background-color: white;
  }
  
  .table th {
    font-size: 15px;
    font-weight: 600;
    padding: 16px 12px;
    vertical-align: middle;
    border-bottom: 2px solid #dee2e6;
    color: #000000;
  }
  
  .table td {
    padding: 14px 12px;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
    color: #000000;
    background-color: white;
  }
  
  .table tbody tr {
    transition: none;
    background-color: white;
  }
  
  .table tbody tr:hover {
    background-color: white !important;
    transform: none;
    box-shadow: none;
  }
  
  /* 호버 효과 제거 */
  .table tbody tr:hover td:nth-child(1),
  .table tbody tr:hover td:nth-child(2),
  .table tbody tr:hover td:nth-child(3),
  .table tbody tr:hover td:nth-child(4),
  .table tbody tr:hover td:nth-child(5),
  .table tbody tr:hover td:nth-child(6) {
    color: #000000 !important;
  }
  
  /* 호버 시 인덱스 배지 효과 제거 */
  .table tbody tr:hover .badge {
    color: #000000 !important;
    background-color: white !important;
    border-color: #dee2e6 !important;
  }
  
  /* 컬럼별 너비 조정 */
  .table th:nth-child(1), .table td:nth-child(1) { /* 티커 */
    width: 80px;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(2), .table td:nth-child(2) { /* 종목명 */
    width: 200px;
    font-weight: 500;
    color: #000000;
  }
  
  .table th:nth-child(3), .table td:nth-child(3) { /* 인덱스 */
    width: 120px;
    text-align: center;
    color: #000000;
  }
  
  .table th:nth-child(4), .table td:nth-child(4) { /* 현재가 */
    width: 100px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(5), .table td:nth-child(5) { /* 연간 배당금 */
    width: 120px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(6), .table td:nth-child(6) { /* 배당 수익률 */
    width: 120px;
    text-align: right;
    font-weight: 600;
    color: #000000;
  }
  
  .table th:nth-child(7), .table td:nth-child(7) { /* 배당월 */
    width: 150px;
    text-align: center;
    color: #000000;
  }
  
  /* 인덱스 배지 스타일 제거 */
  .badge {
    display: none;
  }
  
  .badge.bg-primary {
    display: none;
  }
  
  /* 테이블 컨테이너 개선 */
  .table-responsive {
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    background: white;
  }
  
  /* 테이블 헤더 개선 */
  .table-dark {
    background: white;
    border: none;
  }
  
  .table-dark th {
    border: none;
    color: #000000;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  /* 테이블 내용 배경 */
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: white;
  }
  
  .table-striped tbody tr:nth-of-type(even) {
    background-color: white;
  }
  
  /* 정렬 화살표 스타일 */
  .sort-arrow {
    font-size: 12px;
    margin-left: 5px;
    opacity: 0.7;
    transition: all 0.2s ease;
  }
  
  .sortable:hover .sort-arrow {
    opacity: 1;
    transform: scale(1.1);
  }
  
  /* 정렬 방향에 따른 화살표 변경 */
  .sortable[data-order="asc"] .sort-arrow::after {
    content: "↑";
    color: #28a745;
  }
  
  .sortable[data-order="desc"] .sort-arrow::after {
    content: "↓";
    color: #dc3545;
  }
  
  /* 테이블 제목 스타일 */
  .table-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 3px solid #007bff;
    display: inline-block;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>배당주 선택</h2>
    <a href="/price-admin" class="btn btn-outline-primary btn-sm">
      📈 가격 관리
    </a>
  </div>
  
  <div class="row mb-4">
    <div class="col-md-4">
      <label for="index-select" class="form-label">인덱스 선택:</label>
      <select id="index-select" class="form-select">
        <option value="">전체 인덱스</option>
        <option value="NASDAQ-100">NASDAQ-100</option>
        <option value="S&P 500">S&P 500</option>
        <option value="US ETF">US ETF</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="ticker-select" class="form-label">종목 선택:</label>
      <select id="ticker-select" class="form-select" disabled>
        <option value="">먼저 인덱스를 선택하세요</option>
      </select>
    </div>
    <div class="col-md-4">
      <button id="add-btn" type="button" class="btn btn-primary" disabled>포트폴리오에 추가</button>
    </div>
  </div>

  <div id="stock-info" class="mb-4" style="display: none;">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" id="stock-name"></h5>
        <p class="card-text">
          <strong>티커:</strong> <span id="stock-ticker"></span><br>
          <strong>인덱스</strong> <span id="stock-index"></span><br>
          <strong>현재가</strong> <span id="stock-price"></span><br>
          <strong>배당월</strong> <span id="dividend-months"></span><br>
          <strong>연간 배당금</strong> <span id="annual-dividend"></span>
        </p>
      </div>
    </div>
  </div>

  <h3 class="mb-3">월별 배당 차트</h3>
  <div id="chart-container">
    <canvas id="dividend-chart" width="400" height="200"></canvas>
  </div>

  <!-- 종목 리스트 테이블 -->
  <div class="mt-4">
    <h4 class="table-title">📊 종목 리스트</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th scope="col" class="sortable" data-sort="ticker" data-order="asc" onclick="sortTable('ticker')">
              티커 <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="name" data-order="asc" onclick="sortTable('name')">
              종목명 <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="index" data-order="asc" onclick="sortTable('index')">
              인덱스 <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="price" data-order="asc" onclick="sortTable('price')">
              현재가 <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="dividend" data-order="asc" onclick="sortTable('dividend')">
              연간배당금 <span class="sort-arrow"></span>
            </th>
            <th scope="col" class="sortable" data-sort="yield" data-order="asc" onclick="sortTable('yield')">
              배당수익률 <span class="sort-arrow"></span>
            </th>
            <th scope="col">배당월</th>
          </tr>
        </thead>
        <tbody id="stocks-table-body">
          <!-- 종목 데이터가 여기에 동적으로 추가됩니다 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let dividendChart;
let stocksData = [];
let filteredStocks = [];

// 페이지 로드 시 종목 데이터 가져오기
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/stocks');
    stocksData = await response.json();
    filteredStocks = [...stocksData];
    
    // 인덱스별 통계 표시
    displayIndexStats();
    updateStocksTable(); // 테이블 초기 로딩 시 업데이트
  } catch (error) {
    console.error('종목 데이터를 가져오는데 실패했습니다:', error);
  }
});

// 인덱스별 통계 표시
function displayIndexStats() {
  const stats = {};
  stocksData.forEach(stock => {
    if (!stats[stock.index]) {
      stats[stock.index] = { count: 0, totalDividends: 0 };
    }
    stats[stock.index].count++;
    stats[stock.index].totalDividends += stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
  });
  
  console.log('인덱스별 통계:', stats);
}

// 인덱스 선택 시 이벤트
document.getElementById('index-select').addEventListener('change', function() {
  const selectedIndex = this.value;
  const tickerSelect = document.getElementById('ticker-select');
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  // 종목 선택 초기화
  tickerSelect.innerHTML = '<option value="">종목을 선택하세요</option>';
  tickerSelect.disabled = false;
  addBtn.disabled = true;
  stockInfo.style.display = 'none';
  
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  // 인덱스에 따라 종목 필터링
  if (selectedIndex) {
    filteredStocks = stocksData.filter(stock => stock.index === selectedIndex);
  } else {
    filteredStocks = [...stocksData];
  }
  
  // 종목 선택 옵션 채우기
  filteredStocks.forEach(stock => {
    const option = document.createElement('option');
    option.value = stock.ticker;
    option.textContent = `${stock.ticker} - ${stock.name}`;
    tickerSelect.appendChild(option);
  });
  
  // 인덱스 선택 후 안내 메시지
  if (selectedIndex) {
    tickerSelect.innerHTML = `<option value="">${selectedIndex}에서 종목을 선택하세요</option>`;
    filteredStocks.forEach(stock => {
      const option = document.createElement('option');
      option.value = stock.ticker;
      option.textContent = `${stock.ticker} - ${stock.name}`;
      tickerSelect.appendChild(option);
    });
  }
  updateStocksTable(); // 인덱스 변경 시 테이블 업데이트
});

// 종목 선택 시 이벤트
document.getElementById('ticker-select').addEventListener('change', function() {
  const selectedTicker = this.value;
  const addBtn = document.getElementById('add-btn');
  const stockInfo = document.getElementById('stock-info');
  
  if (selectedTicker) {
    addBtn.disabled = false;
    showStockInfo(selectedTicker);
    updateDividendChart(selectedTicker);
  } else {
    addBtn.disabled = true;
    stockInfo.style.display = 'none';
    if (dividendChart) {
      dividendChart.destroy();
    }
  }
});

// 종목 정보 표시
function showStockInfo(ticker) {
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (!stock) return;
  
  document.getElementById('stock-name').textContent = stock.name;
  document.getElementById('stock-ticker').textContent = stock.ticker;
  document.getElementById('stock-index').textContent = stock.index;
  document.getElementById('stock-price').textContent = `$${stock.price}`;
  
  // 배당월 정보 가져오기
  const dividendMonths = getDividendMonths(stock);
  document.getElementById('dividend-months').textContent = dividendMonths.join(', ');
  
  // 연간 배당금 계산
  const annualDividend = calculateAnnualDividend(stock);
  document.getElementById('annual-dividend').textContent = `$${annualDividend.toFixed(2)}`;
  
  document.getElementById('stock-info').style.display = 'block';
}

// 종목 리스트 테이블 업데이트
function updateStocksTable() {
  const tbody = document.getElementById('stocks-table-body');
  tbody.innerHTML = '';
  
  filteredStocks.forEach(stock => {
    const annualDividend = calculateAnnualDividend(stock);
    const dividendYield = ((annualDividend / stock.price) * 100).toFixed(2);
    const dividendMonths = getDividendMonths(stock);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${stock.ticker}</strong></td>
      <td>${stock.name}</td>
      <td>${stock.index}</td>
      <td>$${stock.price}</td>
      <td>$${annualDividend.toFixed(2)}</td>
      <td>${dividendYield}%</td>
      <td>${dividendMonths.join(', ')}</td>
    `;
    
    // 행 클릭 시 종목 정보 표시
    row.style.cursor = 'pointer';
    row.addEventListener('click', () => {
      document.getElementById('ticker-select').value = stock.ticker;
      showStockInfo(stock.ticker);
      updateDividendChart(stock.ticker);
    });
    
    tbody.appendChild(row);
  });
}

// 테이블 정렬 기능
function sortTable(column) {
  const sortOrder = document.querySelector(`[data-sort="${column}"]`).getAttribute('data-order') === 'asc' ? -1 : 1;
  
  // 모든 헤더의 정렬 순서 초기화
  document.querySelectorAll('[data-sort]').forEach(th => th.setAttribute('data-order', 'asc'));
  
  // 현재 헤더의 정렬 순서 설정
  document.querySelector(`[data-sort="${column}"]`).setAttribute('data-order', sortOrder === 1 ? 'asc' : 'desc');
  
  // 데이터 정렬
  filteredStocks.sort((a, b) => {
    let aVal, bVal;
    
    switch(column) {
      case 'ticker':
        aVal = a.ticker;
        bVal = b.ticker;
        break;
      case 'name':
        aVal = a.name;
        bVal = b.name;
        break;
      case 'index':
        aVal = a.index;
        bVal = b.index;
        break;
      case 'price':
        aVal = parseFloat(a.price);
        bVal = parseFloat(b.price);
        break;
      case 'dividend':
        aVal = calculateAnnualDividend(a);
        bVal = calculateAnnualDividend(b);
        break;
      case 'yield':
        aVal = (calculateAnnualDividend(a) / a.price) * 100;
        bVal = (calculateAnnualDividend(b) / b.price) * 100;
        break;
      default:
        return 0;
    }
    
    if (aVal < bVal) return -1 * sortOrder;
    if (aVal > bVal) return 1 * sortOrder;
    return 0;
  });
  
  updateStocksTable();
  updateDividendChart(filteredStocks[0]);
}

// 배당월 정보 가져오기
function getDividendMonths(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return ['배당 없음'];
  }
  
  const monthNames = [
    '1', '2', '3', '4', '5', '6',
    '7', '8', '9', '10', '11', '12'
  ];
  
  return stock.dividends2024
    .map(d => monthNames[d.month - 1])
    .sort((a, b) => monthNames.indexOf(a) - monthNames.indexOf(b));
}

// 연간 배당금 계산
function calculateAnnualDividend(stock) {
  if (!stock.dividends2024 || stock.dividends2024.length === 0) {
    return 0;
  }
  
  return stock.dividends2024.reduce((sum, d) => sum + d.amount, 0);
}

// 배당 차트 업데이트
function updateDividendChart(ticker) {
  if (dividendChart) {
    dividendChart.destroy();
  }
  
  const ctx = document.getElementById('dividend-chart').getContext('2d');
  
  // 월별 배당 데이터 준비
  const monthlyData = new Array(12).fill(0);
  const monthLabels = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
  
  const stock = filteredStocks.find(s => s.ticker === ticker);
  if (stock && stock.dividends2024) {
    stock.dividends2024.forEach(dividend => {
      monthlyData[dividend.month - 1] = dividend.amount;
    });
  }
  
  dividendChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: '배당금 ($)',
        data: monthlyData,
        backgroundColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(200, 200, 200, 0.3)'),
        borderColor: monthlyData.map(value => value > 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(200, 200, 200, 0.5)'),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `${ticker} 월별 배당 차트`
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              return value > 0 ? `배당금: $${value.toFixed(2)}` : '배당 없음';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: '배당금 ($)'
          }
        },
        x: {
          title: {
            display: true,
            text: '월'
          }
        }
      }
    }
  });
}

// 포트폴리오에 추가 버튼 이벤트
document.getElementById('add-btn').addEventListener('click', function() {
  const selectedTicker = document.getElementById('ticker-select').value;
  if (selectedTicker) {
    // 여기에 포트폴리오 추가 로직 구현
    alert(`${selectedTicker}가 포트폴리오에 추가되었습니다.`);
  }
});
</script>

>>>>>>> update for dividend
<%- include('inc/bottom') %>
